apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: ptf-admin-alerts
  labels:
    app: ptf-admin
    prometheus: kube-prometheus
spec:
  groups:
    - name: ptf-admin-alerts
      rules:
        # ── S1: Scrape / Liveness ──────────────────────────────────
        - alert: PTFAdminMetricsAbsent
          expr: absent(ptf_admin_api_request_total)
          for: 5m
          labels:
            severity: critical
            team: platform
            service: ptf-admin
          annotations:
            summary: "PTF Admin metrikleri kayboldu"
            description: "ptf_admin_api_request_total metriği 5 dakikadır Prometheus'ta görünmüyor. Pod crash, OOM kill veya deployment hatası olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#ptfadminmetricsabsent"

        - alert: PTFAdminTargetDown
          expr: up{job="ptf-admin"} == 0
          for: 2m
          labels:
            severity: critical
            team: platform
            service: ptf-admin
          annotations:
            summary: "PTF Admin scrape target down"
            description: "PTF Admin target 2 dakikadır down. Network policy, service endpoint değişikliği veya Prometheus config hatası olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#ptfadmintargetdown"

        # ── S2: Error Spikes ───────────────────────────────────────
        - alert: PTFAdmin5xxSpike
          expr: >-
            sum(rate(ptf_admin_api_request_total{status_class="5xx"}[5m]))
            /
            sum(rate(ptf_admin_api_request_total[5m]))
            > 0.05
          for: 5m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "PTF Admin 5xx oranı %5 üzerinde"
            description: "Son 5 dakikada 5xx oranı {{ $value | humanizePercentage }}. Unhandled exception, DB connection pool veya upstream timeout olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#ptfadmin5xxspike"

        - alert: PTFAdminExceptionPath
          expr: sum(rate(ptf_admin_api_request_total{status_class="0xx"}[5m])) > 0
          for: 5m
          labels:
            severity: critical
            team: platform
            service: ptf-admin
          annotations:
            summary: "PTF Admin exception path aktif (0xx)"
            description: "Middleware exception path tetiklendi — response üretilmeden exception fırlatıldı. Acil müdahale gerekir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#ptfadminexceptionpath"

        # ── S3: Latency Regression ─────────────────────────────────
        - alert: PTFAdminHighLatency
          expr: >-
            histogram_quantile(0.95,
              sum(rate(ptf_admin_api_request_duration_seconds_bucket[5m])) by (le, endpoint)
            ) > 2
          for: 5m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "PTF Admin P95 latency > 2s"
            description: "Endpoint {{ $labels.endpoint }} P95 latency {{ $value }}s. DB slow query, connection pool exhaustion veya resource contention olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#ptfadminhighlatency"

        - alert: PTFAdminTelemetryLatency
          expr: >-
            histogram_quantile(0.95,
              sum(rate(ptf_admin_api_request_duration_seconds_bucket{endpoint="/admin/telemetry/events"}[5m])) by (le)
            ) > 0.5
          for: 5m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "Telemetry endpoint P95 latency > 500ms"
            description: "Telemetry ingestion P95 {{ $value }}s. Event ingestion bottleneck veya rate limiter misconfiguration olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#ptfadmintelemetrylatency"

        - alert: PTFAdminImportLatency
          expr: >-
            histogram_quantile(0.95,
              sum(rate(ptf_admin_import_apply_duration_seconds_bucket[5m])) by (le)
            ) > 10
          for: 5m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "Import apply P95 latency > 10s"
            description: "Import batch P95 {{ $value }}s. Large batch size, DB lock contention veya disk I/O olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#ptfadminimportlatency"

        # ── S4: Abuse ──────────────────────────────────────────────
        - alert: PTFAdminTelemetryAbuse
          expr: >-
            sum(rate(ptf_admin_api_request_total{endpoint="/admin/telemetry/events",status_class="4xx"}[5m])) * 60 > 10
          for: 5m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "Telemetry endpoint 4xx > 10 req/min"
            description: "Telemetry endpoint'e yüksek 4xx trafiği ({{ $value }} req/min). Bot/scraper, misconfigured frontend veya rate limit trigger olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#ptfadmintelemetryabuse"

        # ── S5: Import Quality ─────────────────────────────────────
        - alert: PTFAdminImportRejectRatio
          expr: >-
            sum(rate(ptf_admin_import_rows_total{outcome="rejected"}[15m]))
            /
            sum(rate(ptf_admin_import_rows_total[15m]))
            > 0.2
          for: 15m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "Import reject oranı > %20"
            description: "Son 15 dakikada import reject oranı {{ $value | humanizePercentage }}. Veri format değişikliği, upstream data quality veya validation rule change olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#ptfadminimportrejectratio"

    # ════════════════════════════════════════════════════════════════
    # Preflight Guard-Rails Alert Group — Feature: preflight-guardrails, Task 6
    # ════════════════════════════════════════════════════════════════
    - name: ptf-admin-preflight-guardrails
      rules:
        # ── A1: PreflightContractBreach ────────────────────────────
        - alert: PreflightContractBreach
          expr: increase(release_preflight_override_total{kind="breach"}[5m]) > 0
          for: 0m
          labels:
            severity: critical
            team: platform
            service: release-preflight
          annotations:
            summary: "CONTRACT BREACH — ABSOLUTE_BLOCK_REASONS override girişimi"
            description: "release_preflight_override_total{kind=\"breach\"} son 5 dakikada artış gösterdi. Sözleşme ihlali — ABSOLUTE_BLOCK_REASONS override edilmeye çalışıldı."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PreflightContractBreach"

        # ── A2: PreflightBlockSpike (mutlak + oran) ───────────────
        - alert: PreflightBlockSpike
          expr: >-
            increase(release_preflight_verdict_total{verdict="BLOCK"}[15m]) > 5
            and
            increase(release_preflight_verdict_total{verdict="BLOCK"}[15m])
            /
            increase(release_preflight_verdict_total[15m])
            > 0.2
          for: 10m
          labels:
            severity: warning
            team: platform
            service: release-preflight
          annotations:
            summary: "Preflight BLOCK spike — son 15 dakikada hem mutlak hem oran eşiği aşıldı"
            description: "release_preflight_verdict_total{verdict=\"BLOCK\"} son 15 dakikada {{ $value }} artış gösterdi ve BLOCK oranı %20'yi aştı."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PreflightBlockSpike"

        # ── A3: PreflightTelemetryWriteFailure ────────────────────
        - alert: PreflightTelemetryWriteFailure
          expr: increase(release_preflight_telemetry_write_failures_total[15m]) > 0
          for: 0m
          labels:
            severity: warning
            team: platform
            service: release-preflight
          annotations:
            summary: "Telemetry write failure — metrik dosyası yazılamadı"
            description: "release_preflight_telemetry_write_failures_total son 15 dakikada artış gösterdi. Disk dolu, izin hatası veya atomic write başarısızlığı olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PreflightTelemetryWriteFailure"

        # ── A4: PreflightCounterReset ─────────────────────────────
        - alert: PreflightCounterReset
          expr: resets(release_preflight_verdict_total[6h]) > 0
          for: 0m
          labels:
            severity: warning
            team: platform
            service: release-preflight
          annotations:
            summary: "Counter reset tespit edildi — monotonluk bozulmuş olabilir"
            description: "release_preflight_verdict_total son 6 saatte {{ $value }} reset gösterdi. Container restart, disk kaybı veya store dosyası silinmiş olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PreflightCounterReset"

    # ════════════════════════════════════════════════════════════════
    # Ops-Guard Alert Group — Feature: ops-guard, Task 8
    # Mevcut ptf-admin-alerts grubu DEĞİŞTİRİLMEDİ.
    # ════════════════════════════════════════════════════════════════
    - name: ptf-admin-ops-guard
      rules:
        # ── OG1: Kill-Switch Activated ─────────────────────────────
        - alert: PTFAdminKillSwitchActivated
          expr: max(ptf_admin_killswitch_state) == 1
          for: 0m
          labels:
            severity: critical
            team: platform
            service: ptf-admin
          annotations:
            summary: "Kill-switch aktif — trafik bilinçli olarak engelleniyor"
            description: "ptf_admin_killswitch_state gauge'u 1 döndü. Bilinçli müdahale veya beklenmeyen toggle olabilir. Hangi switch aktif olduğunu kontrol edin."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminKillSwitchActivated"

        # ── OG2: Circuit Breaker Open (sustained) ─────────────────
        - alert: PTFAdminCircuitBreakerOpen
          expr: max(ptf_admin_circuit_breaker_state) == 2
          for: 5m
          labels:
            severity: critical
            team: platform
            service: ptf-admin
          annotations:
            summary: "Circuit breaker 5+ dakikadır açık"
            description: "ptf_admin_circuit_breaker_state == 2 (open) durumu 5 dakikayı aştı. Bağımlılık arızası devam ediyor, half-open recovery başarısız."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminCircuitBreakerOpen"

        # ── OG3: Rate Limit Deny Spike ────────────────────────────
        - alert: PTFAdminRateLimitSpike
          expr: >-
            sum(rate(ptf_admin_rate_limit_total{decision="deny"}[5m])) * 60 > 5
          for: 2m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "Rate limit deny oranı > 5 req/min (2 dk sürekli)"
            description: "Son 2 dakikada rate limit deny rate {{ $value }} req/min. Abuse, runaway script veya misconfigured client olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminRateLimitSpike"

        # ── OG4: Guard Config Invalid ─────────────────────────────
        - alert: PTFAdminGuardConfigInvalid
          expr: increase(ptf_admin_guard_config_fallback_total[15m]) > 0
          for: 5m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "Guard config validation başarısız — fallback defaults aktif"
            description: "ptf_admin_guard_config_fallback_total son 15 dakikada arttı. Geçersiz env var veya config dosyası. Sistem fallback defaults ile çalışıyor."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminGuardConfigInvalid"

        # ── OG5: Guard Internal Error (fail-open detection) ───────
        - alert: PTFAdminGuardInternalError
          expr: >-
            sum(rate(ptf_admin_killswitch_error_total[5m])) > 0
            or sum(rate(ptf_admin_killswitch_fallback_open_total[5m])) > 0
          for: 5m
          labels:
            severity: critical
            team: platform
            service: ptf-admin
          annotations:
            summary: "Guard katmanı internal error — fail-open path aktif"
            description: "Kill-switch veya guard katmanında internal error tespit edildi. Sistem fail-open modunda çalışıyor olabilir — koruma devre dışı."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminGuardInternalError"

        # ── OG6: SLO Burn Rate (fast window — 1h) ────────────────
        - alert: PTFAdminSLOBurnRateFast
          expr: >-
            sum(rate(ptf_admin_api_request_total{status_class=~"5xx|0xx"}[1h]))
            /
            sum(rate(ptf_admin_api_request_total[1h]))
            > 0.01
          for: 5m
          labels:
            severity: critical
            team: platform
            service: ptf-admin
          annotations:
            summary: "SLO burn rate yüksek (1h window) — error budget hızla tükeniyor"
            description: "Son 1 saatte error rate {{ $value | humanizePercentage }}. Bu hızla error budget 24 saat içinde tükenecek. Acil müdahale gerekli."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminSLOBurnRateFast"

        # ── OG7: SLO Burn Rate (slow window — 6h) ────────────────
        - alert: PTFAdminSLOBurnRateSlow
          expr: >-
            sum(rate(ptf_admin_api_request_total{status_class=~"5xx|0xx"}[6h]))
            /
            sum(rate(ptf_admin_api_request_total[6h]))
            > 0.005
          for: 30m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "SLO burn rate yüksek (6h window) — error budget yavaşça tükeniyor"
            description: "Son 6 saatte error rate {{ $value | humanizePercentage }}. Trend devam ederse error budget birkaç gün içinde tükenecek."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminSLOBurnRateSlow"

    # ════════════════════════════════════════════════════════════════
    # Dependency Wrapper Alert Group — Feature: dependency-wrappers
    # ════════════════════════════════════════════════════════════════
    - name: ptf-admin-dependency-health
      rules:
        # ── DH1: Guard Fail-Open Triggered ────────────────────────
        - alert: PTFAdminGuardFailOpen
          expr: increase(ptf_admin_guard_failopen_total[5m]) > 0
          for: 0m
          labels:
            severity: critical
            team: platform
            service: ptf-admin
          annotations:
            summary: "Guard fail-open tetiklendi — koruma katmanı devre dışı"
            description: "ptf_admin_guard_failopen_total son 5 dakikada arttı. Wrapper veya middleware internal error — sistem korumasız çalışıyor."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminGuardFailOpen"

        # ── DH2: Dependency Map Miss ──────────────────────────────
        - alert: PTFAdminDependencyMapMiss
          expr: increase(ptf_admin_dependency_map_miss_total[10m]) > 0
          for: 5m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "Endpoint dependency map'te bulunamadı — CB pre-check atlandı"
            description: "ptf_admin_dependency_map_miss_total son 10 dakikada arttı. Yeni endpoint wiring kaçırılmış veya mapping drift olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminDependencyMapMiss"

        # ── DH3: Dependency Timeout Rate ──────────────────────────
        - alert: PTFAdminDependencyTimeoutRate
          expr: >-
            sum by (dependency)(
              rate(ptf_admin_dependency_call_total{outcome="timeout"}[5m])
            )
            /
            sum by (dependency)(
              rate(ptf_admin_dependency_call_total[5m])
            )
            > 0.02
          for: 5m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "Dependency timeout oranı > %2"
            description: "{{ $labels.dependency }} timeout oranı {{ $value | humanizePercentage }}. Upstream latency artışı veya timeout threshold düşük olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminDependencyTimeoutRate"

        # ── DH4: Dependency Failure Rate (CB failure class) ───────
        - alert: PTFAdminDependencyFailureRate
          expr: >-
            sum by (dependency)(
              rate(ptf_admin_dependency_call_total{outcome="failure"}[5m])
            )
            /
            sum by (dependency)(
              rate(ptf_admin_dependency_call_total[5m])
            )
            > 0.01
          for: 5m
          labels:
            severity: critical
            team: platform
            service: ptf-admin
          annotations:
            summary: "Dependency failure oranı > %1 (CB failure sınıfı)"
            description: "{{ $labels.dependency }} failure oranı {{ $value | humanizePercentage }}. Connection error, 5xx veya upstream arızası."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminDependencyFailureRate"

        # ── DH5: Client Error Rate (contract drift) ──────────────
        - alert: PTFAdminDependencyClientErrorRate
          expr: >-
            sum by (dependency)(
              rate(ptf_admin_dependency_call_total{outcome="client_error"}[5m])
            )
            /
            sum by (dependency)(
              rate(ptf_admin_dependency_call_total[5m])
            )
            > 0.05
          for: 5m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "Dependency client error oranı > %5 (4xx/ValueError)"
            description: "{{ $labels.dependency }} client error oranı {{ $value | humanizePercentage }}. Contract drift, yanlış parametre veya upstream API değişikliği."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminDependencyClientErrorRate"

        # ── DH6: Retry Storm ──────────────────────────────────────
        - alert: PTFAdminRetryStorm
          expr: >-
            sum by (dependency)(
              rate(ptf_admin_dependency_retry_total[5m])
            )
            /
            sum by (dependency)(
              rate(ptf_admin_dependency_call_total[5m])
            )
            > 0.2
          for: 5m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "Retry oranı > %20 — retry storm riski"
            description: "{{ $labels.dependency }} retry oranı {{ $value | humanizePercentage }}. Zincirleme retry fırtınası başlangıcı olabilir. Retry budget veya backoff ayarlarını gözden geçirin."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminRetryStorm"

        # ── DH7: Dependency P95 Latency ───────────────────────────
        - alert: PTFAdminDependencyLatencyP95
          expr: >-
            histogram_quantile(
              0.95,
              sum by (le, dependency)(
                rate(ptf_admin_dependency_call_duration_seconds_bucket[5m])
              )
            ) > 0.8
          for: 5m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "Dependency P95 latency > 800ms"
            description: "{{ $labels.dependency }} P95 latency {{ $value }}s. Upstream yavaşlama, connection pool exhaustion veya network latency."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminDependencyLatencyP95"

        # ── DH8: Circuit Open Rate (dependency-level) ─────────────
        - alert: PTFAdminDependencyCircuitOpenRate
          expr: >-
            sum by (dependency)(
              rate(ptf_admin_dependency_call_total{outcome="circuit_open"}[5m])
            ) > 0
          for: 2m
          labels:
            severity: critical
            team: platform
            service: ptf-admin
          annotations:
            summary: "Dependency circuit breaker açık — çağrılar reddediliyor"
            description: "{{ $labels.dependency }} için circuit breaker açık, istekler reddediliyor. Upstream arızası devam ediyor."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminDependencyCircuitOpenRate"

    # ════════════════════════════════════════════════════════════════
    # Guard Decision Layer Alert Group — Feature: runtime-guard-decision
    # ════════════════════════════════════════════════════════════════
    - name: ptf-admin-guard-decision
      rules:
        # ── GD1: Snapshot Build Failure (fail-open detection) ─────
        - alert: PTFAdminGuardDecisionBuildFailure
          expr: increase(ptf_admin_guard_decision_snapshot_build_failures_total[15m]) > 0
          for: 0m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "Guard decision snapshot build failure — karar katmanı sessizce devre dışı"
            description: "ptf_admin_guard_decision_snapshot_build_failures_total son 15 dakikada arttı. SnapshotFactory.build() exception fırlattı, fail-open path aktif — stale/insufficient kontrolü yapılmıyor."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminGuardDecisionBuildFailure"

        # ── GD2: Decision Block Rate (stale + insufficient) ──────
        - alert: PTFAdminGuardDecisionBlockRate
          expr: >-
            increase(ptf_admin_guard_decision_block_total[15m]) > 5
            and
            increase(ptf_admin_guard_decision_block_total[15m])
            /
            clamp_min(increase(ptf_admin_guard_decision_requests_total[15m]), 1)
            > 0.01
          for: 5m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "Guard decision layer block oranı yüksek (mutlak > 5 ve oran > %1)"
            description: "ptf_admin_guard_decision_block_total son 15 dakikada mutlak {{ $value }} artış gösterdi ve toplam request'lerin %1'ini aştı. Config stale veya CB mapping miss olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminGuardDecisionBlockRate"

        # ── GD3: Decision Layer Silent (enabled but no requests) ──
        - alert: PTFAdminGuardDecisionSilent
          expr: >-
            increase(ptf_admin_guard_decision_requests_total[15m]) == 0
            and
            increase(ptf_admin_api_request_total[15m]) > 10
          for: 15m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "Guard decision layer sessiz — trafik var ama decision layer çalışmıyor"
            description: "API trafiği var ama guard_decision_requests_total artmıyor. Middleware sırası yanlış, flag kapalı veya skip path sorunu olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminGuardDecisionSilent"
