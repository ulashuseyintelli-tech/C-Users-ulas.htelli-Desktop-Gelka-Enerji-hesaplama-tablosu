apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: ptf-admin-alerts
  labels:
    app: ptf-admin
    prometheus: kube-prometheus
spec:
  groups:
    - name: ptf-admin-alerts
      rules:
        # ── S1: Scrape / Liveness ──────────────────────────────────
        - alert: PTFAdminMetricsAbsent
          expr: absent(ptf_admin_api_request_total)
          for: 5m
          labels:
            severity: critical
            team: platform
            service: ptf-admin
          annotations:
            summary: "PTF Admin metrikleri kayboldu"
            description: "ptf_admin_api_request_total metriği 5 dakikadır Prometheus'ta görünmüyor. Pod crash, OOM kill veya deployment hatası olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#ptfadminmetricsabsent"

        - alert: PTFAdminTargetDown
          expr: up{job="ptf-admin"} == 0
          for: 2m
          labels:
            severity: critical
            team: platform
            service: ptf-admin
          annotations:
            summary: "PTF Admin scrape target down"
            description: "PTF Admin target 2 dakikadır down. Network policy, service endpoint değişikliği veya Prometheus config hatası olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#ptfadmintargetdown"

        # ── S2: Error Spikes ───────────────────────────────────────
        - alert: PTFAdmin5xxSpike
          expr: >-
            sum(rate(ptf_admin_api_request_total{status_class="5xx"}[5m]))
            /
            sum(rate(ptf_admin_api_request_total[5m]))
            > 0.05
          for: 5m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "PTF Admin 5xx oranı %5 üzerinde"
            description: "Son 5 dakikada 5xx oranı {{ $value | humanizePercentage }}. Unhandled exception, DB connection pool veya upstream timeout olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#ptfadmin5xxspike"

        - alert: PTFAdminExceptionPath
          expr: sum(rate(ptf_admin_api_request_total{status_class="0xx"}[5m])) > 0
          for: 5m
          labels:
            severity: critical
            team: platform
            service: ptf-admin
          annotations:
            summary: "PTF Admin exception path aktif (0xx)"
            description: "Middleware exception path tetiklendi — response üretilmeden exception fırlatıldı. Acil müdahale gerekir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#ptfadminexceptionpath"

        # ── S3: Latency Regression ─────────────────────────────────
        - alert: PTFAdminHighLatency
          expr: >-
            histogram_quantile(0.95,
              sum(rate(ptf_admin_api_request_duration_seconds_bucket[5m])) by (le, endpoint)
            ) > 2
          for: 5m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "PTF Admin P95 latency > 2s"
            description: "Endpoint {{ $labels.endpoint }} P95 latency {{ $value }}s. DB slow query, connection pool exhaustion veya resource contention olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#ptfadminhighlatency"

        - alert: PTFAdminTelemetryLatency
          expr: >-
            histogram_quantile(0.95,
              sum(rate(ptf_admin_api_request_duration_seconds_bucket{endpoint="/admin/telemetry/events"}[5m])) by (le)
            ) > 0.5
          for: 5m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "Telemetry endpoint P95 latency > 500ms"
            description: "Telemetry ingestion P95 {{ $value }}s. Event ingestion bottleneck veya rate limiter misconfiguration olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#ptfadmintelemetrylatency"

        - alert: PTFAdminImportLatency
          expr: >-
            histogram_quantile(0.95,
              sum(rate(ptf_admin_import_apply_duration_seconds_bucket[5m])) by (le)
            ) > 10
          for: 5m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "Import apply P95 latency > 10s"
            description: "Import batch P95 {{ $value }}s. Large batch size, DB lock contention veya disk I/O olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#ptfadminimportlatency"

        # ── S4: Abuse ──────────────────────────────────────────────
        - alert: PTFAdminTelemetryAbuse
          expr: >-
            sum(rate(ptf_admin_api_request_total{endpoint="/admin/telemetry/events",status_class="4xx"}[5m])) * 60 > 10
          for: 5m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "Telemetry endpoint 4xx > 10 req/min"
            description: "Telemetry endpoint'e yüksek 4xx trafiği ({{ $value }} req/min). Bot/scraper, misconfigured frontend veya rate limit trigger olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#ptfadmintelemetryabuse"

        # ── S5: Import Quality ─────────────────────────────────────
        - alert: PTFAdminImportRejectRatio
          expr: >-
            sum(rate(ptf_admin_import_rows_total{outcome="rejected"}[15m]))
            /
            sum(rate(ptf_admin_import_rows_total[15m]))
            > 0.2
          for: 15m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "Import reject oranı > %20"
            description: "Son 15 dakikada import reject oranı {{ $value | humanizePercentage }}. Veri format değişikliği, upstream data quality veya validation rule change olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#ptfadminimportrejectratio"

    # ════════════════════════════════════════════════════════════════
    # Ops-Guard Alert Group — Feature: ops-guard, Task 8
    # Mevcut ptf-admin-alerts grubu DEĞİŞTİRİLMEDİ.
    # ════════════════════════════════════════════════════════════════
    - name: ptf-admin-ops-guard
      rules:
        # ── OG1: Kill-Switch Activated ─────────────────────────────
        - alert: PTFAdminKillSwitchActivated
          expr: max(ptf_admin_killswitch_state) == 1
          for: 0m
          labels:
            severity: critical
            team: platform
            service: ptf-admin
          annotations:
            summary: "Kill-switch aktif — trafik bilinçli olarak engelleniyor"
            description: "ptf_admin_killswitch_state gauge'u 1 döndü. Bilinçli müdahale veya beklenmeyen toggle olabilir. Hangi switch aktif olduğunu kontrol edin."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminKillSwitchActivated"

        # ── OG2: Circuit Breaker Open (sustained) ─────────────────
        - alert: PTFAdminCircuitBreakerOpen
          expr: max(ptf_admin_circuit_breaker_state) == 2
          for: 5m
          labels:
            severity: critical
            team: platform
            service: ptf-admin
          annotations:
            summary: "Circuit breaker 5+ dakikadır açık"
            description: "ptf_admin_circuit_breaker_state == 2 (open) durumu 5 dakikayı aştı. Bağımlılık arızası devam ediyor, half-open recovery başarısız."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminCircuitBreakerOpen"

        # ── OG3: Rate Limit Deny Spike ────────────────────────────
        - alert: PTFAdminRateLimitSpike
          expr: >-
            sum(rate(ptf_admin_rate_limit_total{decision="deny"}[5m])) * 60 > 5
          for: 2m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "Rate limit deny oranı > 5 req/min (2 dk sürekli)"
            description: "Son 2 dakikada rate limit deny rate {{ $value }} req/min. Abuse, runaway script veya misconfigured client olabilir."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminRateLimitSpike"

        # ── OG4: Guard Config Invalid ─────────────────────────────
        - alert: PTFAdminGuardConfigInvalid
          expr: increase(ptf_admin_guard_config_fallback_total[15m]) > 0
          for: 5m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "Guard config validation başarısız — fallback defaults aktif"
            description: "ptf_admin_guard_config_fallback_total son 15 dakikada arttı. Geçersiz env var veya config dosyası. Sistem fallback defaults ile çalışıyor."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminGuardConfigInvalid"

        # ── OG5: Guard Internal Error (fail-open detection) ───────
        - alert: PTFAdminGuardInternalError
          expr: >-
            sum(rate(ptf_admin_killswitch_error_total[5m])) > 0
            or sum(rate(ptf_admin_killswitch_fallback_open_total[5m])) > 0
          for: 5m
          labels:
            severity: critical
            team: platform
            service: ptf-admin
          annotations:
            summary: "Guard katmanı internal error — fail-open path aktif"
            description: "Kill-switch veya guard katmanında internal error tespit edildi. Sistem fail-open modunda çalışıyor olabilir — koruma devre dışı."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminGuardInternalError"

        # ── OG6: SLO Burn Rate (fast window — 1h) ────────────────
        - alert: PTFAdminSLOBurnRateFast
          expr: >-
            sum(rate(ptf_admin_api_request_total{status_class=~"5xx|0xx"}[1h]))
            /
            sum(rate(ptf_admin_api_request_total[1h]))
            > 0.01
          for: 5m
          labels:
            severity: critical
            team: platform
            service: ptf-admin
          annotations:
            summary: "SLO burn rate yüksek (1h window) — error budget hızla tükeniyor"
            description: "Son 1 saatte error rate {{ $value | humanizePercentage }}. Bu hızla error budget 24 saat içinde tükenecek. Acil müdahale gerekli."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminSLOBurnRateFast"

        # ── OG7: SLO Burn Rate (slow window — 6h) ────────────────
        - alert: PTFAdminSLOBurnRateSlow
          expr: >-
            sum(rate(ptf_admin_api_request_total{status_class=~"5xx|0xx"}[6h]))
            /
            sum(rate(ptf_admin_api_request_total[6h]))
            > 0.005
          for: 30m
          labels:
            severity: warning
            team: platform
            service: ptf-admin
          annotations:
            summary: "SLO burn rate yüksek (6h window) — error budget yavaşça tükeniyor"
            description: "Son 6 saatte error rate {{ $value | humanizePercentage }}. Trend devam ederse error budget birkaç gün içinde tükenecek."
            runbook_url: "https://github.com/<repo>/blob/main/monitoring/runbooks/ptf-admin-runbook.md#PTFAdminSLOBurnRateSlow"
